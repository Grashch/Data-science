Функция agg() (от aggregate — «агрегировать, суммировать») в pandas — ключевой инструмент для вычисления сводных статистических показателей по группам данных. Разберём её работу максимально подробно.

Когда используется agg()
agg() применяется после:
groupby() — группировка по столбцам;
выбора столбца/серии — агрегация по всему столбцу.

Основная задача: превратить множество значений в одно итоговое (сумму, среднее, счёт и т. п.).

Базовый синтаксис
python
df.groupby('столбец_для_группировки').agg({'столбец': 'функция'})

Пусть есть DataFrame:

python
import pandas as pd
data = pd.DataFrame({'sales': [100, 200, 150, 300]})

Применяем agg() к столбцу:
python
data['sales'].agg('sum')        # 750
data['sales'].agg('mean')        # 187.5
data['sales'].agg('count')       # 4
data['sales'].agg(['sum', 'mean', 'max'])  # словарь с несколькими результатами

Работа с groupby() + agg()
Пример данных:
python
df = pd.DataFrame({
    'region': ['A', 'A', 'B', 'B'],
    'sales': [100, 200, 150, 300],
    'profit': [10, 20, 15, 30]
})
Группируем по region и считаем сумму продаж:

python
df.groupby('region').agg({'sales': 'sum'})
Результат:
       sales
region       
A         300
B         450

Способы задания функций агрегации
1. Строковое название (базовые функции)
python
.agg({'столбец': 'sum'})
.agg({'столбец': 'mean'})
.agg({'столбец': 'count'})
.agg({'столбец': 'min'})
.agg({'столбец': 'max'})
.agg({'столбец': 'std'})   # стандартное отклонение
.agg({'столбец': 'first'}) # первое значение в группе
.agg({'столбец': 'last'})  # последнее значение

2. Список функций (несколько сразу)
python
df.groupby('region').agg({
    'sales': ['sum', 'mean', 'count'],
    'profit': ['sum', 'max']
})
Результат — MultiIndex столбцов:

        sales             profit
        sum  mean count    sum max
region                           
A       300 150.0     2     30  20
B       450 225.0     2     45  30

3. Словарь с разными функциями для разных столбцов
python
df.groupby('region').agg({
    'sales': 'sum',
    'profit': 'mean'
})
4. Лямбда‑функции (для кастомных расчётов)
python
df.groupby('region').agg({
    'sales': lambda x: x.sum() * 1.1  # сумма с наценкой 10%
})
5. Именованные агрегации (современный синтаксис, pandas ≥ 0.25)
python
df.groupby('region').agg(
    total_sales=('sales', 'sum'),
    avg_profit=('profit', 'mean'),
    transaction_count=('sales', 'count')
)
Преимущества:

сразу задаёте имена итоговых столбцов;

читаемый код;

можно комбинировать разные столбцы и функции.

Важные нюансы
1. Сохранение индексов
По умолчанию groupby().agg() делает группировочные столбцы индексами результата. Чтобы вернуть их в столбцы:

python
.reset_index()
Полный пример:

python
result = (df
          .groupby('region')
          .agg(total_sales=('sales', 'sum'))
          .reset_index()
         )
2. Работа с пропущенными значениями (NaN)
sum(), mean() и др. автоматически пропускают NaN;

чтобы учитывать NaN, используйте skipna=False внутри лямбды.

3. Агрегация по нескольким столбцам группировки
python
df.groupby(['region', 'year']).agg({'sales': 'sum'})
4. Сохранение типов данных
agg() может менять типы (например, int → float при mean). Проверяйте:

python
result.dtypes
Практические примеры
Пример 1. Базовая агрегация
python
df.groupby('category').agg(total_sales=('revenue', 'sum'))
Пример 2. Несколько показателей
python
df.groupby('manager').agg(
    deals=('id', 'count'),
    revenue=('amount', 'sum'),
    avg_deal=('amount', 'mean')
)
Пример 3. Сложная логика через лямбду
python
df.groupby('team').agg(
    # Доля успешных сделок (> 1000)
    success_rate=('amount', lambda x: (x > 1000).mean())
)
Пример 4. Комбинированная агрегация
python
df.groupby('month').agg(
    total_orders=('order_id', 'count'),
    revenue=('price', 'sum'),
    top_product=('product', 'first'),  # первый товар месяца
    avg_price=('price', 'mean')
).reset_index()

Типичные ошибки
Неправильный синтаксис словаря
python
# Неверно:
.agg({'sales': sum})  # без кавычек
# Верно:
.agg({'sales': 'sum'})
Забытый reset_index()
Если нужны группировочные столбцы как данные, а не индексы.

Смешение старого и нового синтаксиса
Лучше выбирать один стиль (либо словарь, либо именованные агрегации).

Итог
agg() — универсальный инструмент для:
подсчёта сумм, средних, количества;
применения кастомных функций через лямбды;
формирования отчётов с понятными названиями столбцов.

Ключевые правила:
1. Используйте groupby() перед agg(), если нужна группировка.
2. Для именованных столбцов — современный синтаксис с кортежами.
3. Добавляйте reset_index(), если группировочные столбцы должны остаться в данных.
4. Проверяйте типы данных и обработку NaN.
